{% extends "base.html" %}

{% load show_pagination_links %}

{% block title %}Gestion des ADS{% endblock %}

{% block body %}
<nav role="navigation" class="fr-breadcrumb" aria-label="vous êtes ici :">
  <button class="fr-breadcrumb__button" aria-expanded="false" aria-controls="breadcrumb-1">Voir le fil d’Ariane</button>
  <div class="fr-collapse" id="breadcrumb-1">
    <ol class="fr-breadcrumb__list">
      <li>
        <a class="fr-breadcrumb__link" href="{% url 'ads-manager-request' %}">Gestion des ADS</a>
      </li>
      <li>
        <a class="fr-breadcrumb__link" aria-current="page">{{ ads_manager.content_object.display_text|capfirst }}</a>
      </li>
    </ol>
  </div>
</nav>

<p>
  <a class="fr-link fr-icon-arrow-right-line fr-link--icon-right" href="{% url 'ads.create' manager_id=ads_manager.id %}">Créer une nouvelle ADS</a>
</p>

<div x-data="{ displayFilters: new URLSearchParams(window.location.search).get('q') || new URLSearchParams(window.location.search).get('accepted_cpam')}">
  <p id="ADSFiltersButton">
    <button
      x-show="! displayFilters"
      x-on:click="displayFilters = true"
      class="fr-link fr-icon-arrow-right-line fr-link--icon-right">
        Rechercher une ADS
    </button>
    <button
      x-show="displayFilters"
      x-on:click="displayFilters = false"
      class="fr-link fr-icon-arrow-down-line fr-link--icon-right">
        Rechercher une ADS
    </button>
  </p>

  <div x-show="displayFilters" id="ADSFilters">
    <h6>Filtrer les ADS</h6>

    <form method="get" class="fr-mb-3w">
      <!-- form.q -->
      <div class="fr-col-lg-6 fr-input-group{% if search_form.q.errors %} fr-input-group--error{% endif %}">
        <label class="fr-label" for="{{ search_form.q.id_for_label }}">
          Rechercher par nom ou SIRET du titulaire, ou de l'exploitant, ou plaque d'immatriculation du véhicule
        </label>

        <input class="fr-input{% if search_form.q.errors %} fr-input--error{% endif %}" type="text"
          id="{{ search_form.q.id_for_label }}" name="{{ search_form.q.html_name }}"
          value="{{ search_form.q.value|default:"" }}" />

        {% for error in search_form.q.errors %}
        <p class="fr-error-text">
          {{ error }}
        </p>
        {% endfor %}
      </div>

      <!-- form.accepted_cpam  -->
      <div
        class="fr-col-lg-6 fr-select-group{% if search_form.accepted_cpam.errors %} fr-select-group--error{% endif %}">
        <label class="fr-label" for="{{ search_form.accepted_cpam.id_for_label }}">
          Lister seulement les ADS conventionnées CPAM ?
        </label>

        <select class="fr-select{% if search_form.accepted_cpam.errors %} fr-select--error{% endif %}"
          id="{{ search_form.accepted_cpam.id_for_label }}" name="{{ search_form.accepted_cpam.html_name }}">
          {% for option in search_form.accepted_cpam %}
          {{ option }}
          {% endfor %}
        </select>

        {% for error in search_form.accepted_cpam.errors %}
        <p class="fr-error-text">
          {{ error }}
        </p>
        {% endfor %}
      </div>

      <div class="fr-input-group">
        <button type="submit" class="fr-btn">Filtrer</button>
      </div>
    </form>
  </div>
</div>

<div class="fr-table">
  <table>
    <caption>ADS de {{ ads_manager.content_object.display_fulltext }}</caption>
    <thead>
      <tr>
        <th>♯ Numéro</th>
        <th>📜 Date de création</th>
        <th>🗓 Date d'attribution<br />au titulaire actuel</th>
        <th>🚑 Conventionné<br />CPAM ?</th>
        <th>🤴 Titulaire</th>
        <th>🔎 Action</th>
    </thead>
    <tbody>
      {% for ads in ads_list %}
      <tr>
        <td><a href="{% url 'ads' manager_id=ads_manager.id ads_id=ads.id %}">{{ ads.number }}</a></td>
        <td>{{ ads.ads_creation_date|default:"" }}</td>
        <td>{{ ads.attribution_date|default:"" }}</td>
        <td>{% if ads.accepted_cpam is None %}⁉️  Inconnu{% elif ads.accepted_cpam is True %}👍 Oui{% else %}❌ Non{% endif %}</td>
        <td>{{ ads.owner_name }}</td>
        <td>
          <a class="fr-btn fr-btn--sm" href="{% url 'ads' manager_id=ads_manager.id ads_id=ads.id %}">Détails</a>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="7">Aucune ADS enregistrée</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {% show_pagination_links page_obj %}
</div>
{% endblock %}