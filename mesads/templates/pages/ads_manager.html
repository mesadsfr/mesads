{% extends "base.html" %}

{% load show_pagination_links %}

{% block title %}Gestion des ADS{% endblock %}

{% block body %}

<nav role="navigation" class="fr-breadcrumb" aria-label="vous √™tes ici :">
  <button class="fr-breadcrumb__button" aria-expanded="false" aria-controls="breadcrumb-1">Voir le fil d‚ÄôAriane</button>
  <div class="fr-collapse" id="breadcrumb-1">
    <ol class="fr-breadcrumb__list">
      <li>
        <a class="fr-breadcrumb__link" href="{% url 'app.ads-manager.index' %}">Gestion des ADS</a>
      </li>
      <li>
        <a class="fr-breadcrumb__link" aria-current="page">{{ ads_manager.content_object.display_text|capfirst }}</a>
      </li>
    </ol>
  </div>
</nav>

{% comment %}If the administration declared it does not manage ADS, hide the creation button.{% endcomment %}
{% if not ads_manager.no_ads_declared %}
<p>
  <a class="fr-link fr-icon-arrow-right-line fr-link--icon-right" href="{% url 'app.ads.create' manager_id=ads_manager.id %}">Cr√©er une nouvelle ADS</a>
</p>
{% endif %}

{% if not ads_list.count %}
  {% comment %}
    If the administration does not manage ADS, it is either because it has not declared it yet, or because it has declared it does not manage ADS.
  {% endcomment %}
  {% if ads_manager.no_ads_declared %}
  <p>
    Vous avez d√©clar√© que votre administration ne g√®re aucune ADS.
  </p>

  <p>
    S'il s'agit d'une erreur, ou si votre administration est dor√©navant gestionnaire d'ADS, il vous suffit de d√©cocher la case ci-dessous.
  </p>
  {% else %}
  <p>
    Aucune ADS n'est actuellement enregistr√©e pour votre administration. Vous pouvez :
  </p>

  <ul>
    <li>En cr√©er une nouvelle en cliquant sur le lien ci-dessus.</li>
    <li>Ou utiliser le formulaire ci-dessous pour d√©clarer que votre administration ne g√®re aucune ADS.</li>
  </ul>
  {% endif %}

  <form class="fr-col-10 fr-col-sm-6 fr-col-md-4" method="post">
    {% if form.non_field_errors %}
      <div class="fr-input-group fr-input-group--error">
        {% for error in form.non_field_errors %}
        <p class="fr-error-text">
          {{ error }}
        </p>
        {% endfor %}
      </div>
    {% endif %}

    {% csrf_token %}

    {% include 'pages/ads-form_bool.html' with field_title="Je d√©clare que mon administration ne g√®re aucune ADS" field=edit_form.no_ads_declared field_errors=edit_form.errors.no_ads_declared required=edit_form.fields.no_ads_declared.required %}

    <div class="fr-col-12 fr-input-group">
      <ul class="fr-btns-group">
        <li>
          <button type="submit" class="fr-btn">Valider</button>
        </li>
    </div>
  </form>

{% else %}
<div x-data="{ displayFilters: new URLSearchParams(window.location.search).get('q') || new URLSearchParams(window.location.search).get('accepted_cpam')}">
  <p id="ADSFiltersButton">
    <button
      x-show="! displayFilters"
      x-on:click="displayFilters = true"
      class="fr-link fr-icon-arrow-right-line fr-link--icon-right">
        Rechercher une ADS
    </button>
    <button
      x-show="displayFilters"
      x-on:click="displayFilters = false"
      class="fr-link fr-icon-arrow-down-line fr-link--icon-right">
        Rechercher une ADS
    </button>
  </p>

  <div x-show="displayFilters" id="ADSFilters" x-transition>
    <h6>Filtrer les ADS</h6>

    <form method="get" class="fr-mb-3w">
      <!-- form.q -->
      <div class="fr-col-lg-6 fr-input-group{% if search_form.q.errors %} fr-input-group--error{% endif %}">
        <label class="fr-label" for="{{ search_form.q.id_for_label }}">
          Rechercher par nom ou SIRET du titulaire, ou de l'exploitant, ou plaque d'immatriculation du v√©hicule
        </label>

        <input class="fr-input{% if search_form.q.errors %} fr-input--error{% endif %}" type="text"
          id="{{ search_form.q.id_for_label }}" name="{{ search_form.q.html_name }}"
          value="{{ search_form.q.value|default:"" }}" />

        {% for error in search_form.q.errors %}
        <p class="fr-error-text">
          {{ error }}
        </p>
        {% endfor %}
      </div>

      <!-- form.accepted_cpam  -->
      <div
        class="fr-col-lg-6 fr-select-group{% if search_form.accepted_cpam.errors %} fr-select-group--error{% endif %}">
        <label class="fr-label" for="{{ search_form.accepted_cpam.id_for_label }}">
          Lister seulement les ADS conventionn√©es CPAM ?
        </label>

        <select class="fr-select{% if search_form.accepted_cpam.errors %} fr-select--error{% endif %}"
          id="{{ search_form.accepted_cpam.id_for_label }}" name="{{ search_form.accepted_cpam.html_name }}">
          {% for option in search_form.accepted_cpam %}
          {{ option }}
          {% endfor %}
        </select>

        {% for error in search_form.accepted_cpam.errors %}
        <p class="fr-error-text">
          {{ error }}
        </p>
        {% endfor %}
      </div>

      <div class="fr-input-group">
        <button type="submit" class="fr-btn">Filtrer</button>
      </div>
    </form>
  </div>
</div>

<div class="fr-table">
  <table>
    <caption>ADS de {{ ads_manager.content_object.display_fulltext }}</caption>
    <thead>
      <tr>
        {% if ads_manager.content_type.name == 'EPCI' %}
        <th>üåÜ Commune</th>
        {% endif %}
        <th>‚ôØ Num√©ro</th>
        <th>üìú Date de cr√©ation</th>
        <th>üóì Date d'attribution<br />au titulaire actuel</th>
        <th>üöë Conventionn√©<br />CPAM ?</th>
        <th>ü§¥ Titulaire</th>
        <th>üîé Action</th>
    </thead>
    <tbody>
      {% for ads in ads_list %}
      <tr>
        {% if ads_manager.content_type.name == 'EPCI' %}
        <td>{{ ads.epci_commune.libelle|default:"" }}</td>
        {% endif %}
        <td><a href="{% url 'app.ads.detail' manager_id=ads_manager.id ads_id=ads.id %}">{{ ads.number }}</a></td>
        <td>{{ ads.ads_creation_date|default:"" }}</td>
        <td>{{ ads.attribution_date|default:"" }}</td>
        <td>{% if ads.accepted_cpam is None %}‚ÅâÔ∏è  Inconnu{% elif ads.accepted_cpam is True %}üëç Oui{% else %}‚ùå Non{% endif %}</td>
        <td>{{ ads.owner_name }}</td>
        <td>
          <a class="fr-btn fr-btn--sm" href="{% url 'app.ads.detail' manager_id=ads_manager.id ads_id=ads.id %}">D√©tails</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% show_pagination_links page_obj %}
</div>
{% endif %}

{% endblock %}