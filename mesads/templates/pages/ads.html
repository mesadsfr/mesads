{% extends "base.html" %}

{% block title %}Gestion des ADS{% endblock %}

{% block body %}
<nav role="navigation" class="fr-breadcrumb" aria-label="vous êtes ici :">
  <button class="fr-breadcrumb__button" aria-expanded="false" aria-controls="breadcrumb-1">Voir le fil d’Ariane</button>
  <div class="fr-collapse" id="breadcrumb-1">
    <ol class="fr-breadcrumb__list">
      <li>
        <a class="fr-breadcrumb__link" href="{% url 'ads-manager-request' %}">Gestion des ADS</a>
      </li>
      <li>
        <a class="fr-breadcrumb__link" href="{% url 'ads-manager' manager_id=ads_manager.id %}">{{ ads_manager.content_object.display_text|capfirst }}</a>
      </li>
      <li>
      {% if ads %}
        <a class="fr-breadcrumb__link" aria-current="page">ADS numéro {{ ads.number }}</a>
      {% else %}
        <a class="fr-breadcrumb__link" aria-current="page">Création d'une nouvelle ADS</a>
      {% endif %}
      </li>
    </ol>
  </div>
</nav>

{% if ads %}
<p>
  <a class="fr-link fr-icon-arrow-right-line fr-link--icon-right" href="{% url 'ads.delete' manager_id=ads_manager.id ads_id=ads.id %}">Supprimer cette ADS</a>
</p>
{% endif %}

<h1>
{% if ads %}
ADS numéro {{ ads.number }} ({{ ads.ads_manager.content_object.display_text|capfirst }})
{% else %}
Création d'une nouvelle ADS
{% endif %}
</h1>

<script type="text/javascript">
  const get_x_data = () => ({
      ads_type: '{{ form.ads_type.value }}',
      used_by_owner: '{{ form.used_by_owner.value }}',
      attribution_type: '{{ form.attribution_type.value }}',
      numberOfADSUsersFormsetToDisplay: (() => {
        // All forms
        const ads_user_forms = [...document.getElementsByClassName('ads-user-form')];
        // List, returns true if the form is empty, false otherwise
        const filled  = ads_user_forms.map((e) => !!e.querySelector('input:not([type="hidden"]):not([value=""])'));
        // Reverse to have last forms first
        const reversed = filled.reverse();
        // Index of the first non-empty form
        const nonEmptyFormIdx = reversed.findIndex((e) => e === true);
        return {{ ads_users_formset.extra }} - nonEmptyFormIdx;
      })(),
  });
</script>

<div
  class="fr-grid-row"
  x-data="get_x_data()"
>
  <form class="fr-col-12 fr-col-sm-8 fr-col-md-6" method="post" enctype="multipart/form-data">
    {% if form.non_field_errors %}
      <div class="fr-input-group fr-input-group--error">
        {% for error in form.non_field_errors %}
        <!-- Non-field error -->
        <p class="fr-error-text">
          {{ error }}
        </p>
        {% endfor %}
      </div>
    {% endif %}

    {% csrf_token %}

    <!-- ADS number -->
    {% include 'pages/ads-form_string.html' with field_title="Numéro de l'ADS" field=form.number field_errors=form.errors.number required=form.fields.number.required %}

    <!-- ADS creation date -->
    {% include 'pages/ads-form_date.html' with field_title="Date de création de l'ADS" field=form.ads_creation_date field_errors=form.errors.ads_creation_date required=form.fields.ads_creation_date.required %}

    <!-- ADS type -->
    {% include 'pages/ads-form_select.html' with x_model="ads_type" field_title="Type d'ADS" field=form.ads_type field_errors=form.errors.ads_type required=form.fields.ads_type.required %}

    <!-- ADS attribution date -->
    {% include 'pages/ads-form_date.html' with field_title="Date d'attribution de l'ADS au titulaire actuel" field=form.attribution_date field_errors=form.errors.attribution_date required=form.fields.attribution_date.required %}

    <!-- ADS attribution type -->
    {% include 'pages/ads-form_select.html' with x_model="attribution_type" field_title="Type d'attribution de l'ADS" field=form.attribution_type field_errors=form.errors.attribution_type required=form.fields.attribution_type.required %}

    <!-- Transaction identifier -->
    {% include 'pages/ads-form_string.html' with x_show="attribution_type == 'paid'" field_title="Numéro d'identification lié au registre des transactions" field=form.transaction_identifier field_errors=form.errors.transaction_identifier required=form.fields.transaction_identifier.required %}

    <!-- ADS attribution reason -->
    {% include 'pages/ads-form_string.html' with field_title="Raison d'attribution" field=form.attribution_reason field_errors=form.errors.attribution_reason required=form.fields.attribution_reason.required %}

    <!-- Accepted by CPAM -->
    {% include 'pages/ads-form_select.html' with field_title="Véhicule conventionné CPAM ?" field=form.accepted_cpam field_errors=form.errors.accepted_cpam required=form.fields.accepted_cpam.required %}

    <!-- Immatriculation plate -->
    {% include 'pages/ads-form_string.html' with field_title="Plaque d'immatriculation" field=form.immatriculation_plate field_errors=form.errors.immatriculation_plate required=form.fields.immatriculation_plate.required %}

    <!-- Compatible PMR ? -->
    {% include 'pages/ads-form_select.html' with field_title="Véhicule compatible PMR ?" field=form.vehicle_compatible_pmr field_errors=form.errors.vehicle_compatible_pmr required=form.fields.vehicle_compatible_pmr.required %}

    <!-- Eco vehicle ? -->
    {% include 'pages/ads-form_select.html' with field_title="Véhicule électrique ou hybride ?" field=form.eco_vehicle field_errors=form.errors.eco_vehicle required=form.fields.eco_vehicle.required %}

    <!-- Owner name -->
    {% include 'pages/ads-form_string.html' with field_title="Nom du titulaire de l'ADS" field=form.owner_name field_errors=form.errors.owner_name required=form.fields.owner_name.required %}

    <!-- Owner SIRET -->
    {% include 'pages/ads-form_string.html' with field_title="SIRET du titulaire de l'ADS" field=form.owner_siret field_errors=form.errors.owner_siret required=form.fields.owner_siret.required %}

    <!-- Owner phone -->
    {% include 'pages/ads-form_string.html' with field_title="Téléphone fixe du titulaire de l'ADS" field=form.owner_phone field_errors=form.errors.owner_phone required=form.fields.owner_phone.required %}

    <!-- Owner mobile -->
    {% include 'pages/ads-form_string.html' with field_title="Téléphone mobile du titulaire de l'ADS" field=form.owner_mobile field_errors=form.errors.owner_mobile required=form.fields.owner_mobile.required %}

    <!-- Owner email -->
    {% include 'pages/ads-form_string.html' with field_title="Email du titulaire de l'ADS" field=form.owner_email field_errors=form.errors.owner_email required=form.fields.owner_email.required html_type="email" %}

    <div class="fr-input-group" x-show="ads_type !== 'new'">
      <!-- Used by owner ? -->
      {% include 'pages/ads-form_select.html' with x_model="used_by_owner" field_title="ADS exploitée par son titulaire ?" field=form.used_by_owner field_errors=form.errors.used_by_owner required=form.fields.used_by_owner.required %}

      <div x-show="used_by_owner !== 'true'">
        {{ ads_users_formset.management_form }}

        {% for ads_user_form in ads_users_formset %}
          <div
            x-show="{{ forloop.counter0 }} < numberOfADSUsersFormsetToDisplay"
            class="fr-form-group ads-user-form"
          >
            <fieldset class="fr-fieldset">
                <legend class="fr-fieldset__legend">{{ forloop.counter }}<sup>{% if forloop.counter == 1 %}er{% else %}e{% endif %}</sup> exploitant taxi</legend>

              <div class="fr-pl-3w">
                <!-- User status -->
                {% include 'pages/ads-form_select.html' with field_title="Statut de l'exploitant de l'ADS" field=ads_user_form.status field_errors=ads_user_form.errors.status required=ads_user_form.fields.status.required %}
                <!-- User name -->
                {% include 'pages/ads-form_string.html' with field_title="Nom de l'exploitant de l'ADS" field=ads_user_form.name field_errors=ads_user_form.errors.name required=ads_user_form.fields.name.required %}
                <!-- User SIRET -->
                {% include 'pages/ads-form_string.html' with field_title="SIRET de l'exploitant de l'ADS" field=ads_user_form.siret field_errors=ads_user_form.errors.siret required=ads_user_form.fields.siret.required %}
              </div>

              {% for hidden_field in ads_user_form.hidden_fields %}
                {{ hidden_field }}
              {% endfor %}
            </fieldset>
          </div>
        {% endfor %}

        <button
          type="button"
          id="displayADSUserForm"
          class="fr-btn fr-btn--sm fr-icon-checkbox-circle-line fr-btn--icon-left fr-btn--secondary"
          x-on:click="numberOfADSUsersFormsetToDisplay++"
          x-show="numberOfADSUsersFormsetToDisplay < {{ ads_users_formset.extra }}"
        >
            Ajouter un exploitant
        </button>
      </div>
    </div>

    <!-- Legal file -->
    {% include 'pages/ads-form_file.html' with field_title="Arrêté portant l'attribution de l'ADS" field=form.legal_file field_errors=form.errors.legal_file required=form.fields.legal_file.required %}

    <div class="fr-col-12 fr-input-group">
      {% if ads %}
      <button type="submit" class="fr-btn">Modifier</button>
      {% else %}
      <button type="submit" class="fr-btn">Créer la nouvelle ADS</button>
      {% endif %}
    </div>

  </form>
</div>
{% endblock %}