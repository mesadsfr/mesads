{% extends "./base.html" %}

{% load show_pagination_links %}

{% block main %}
<nav role="navigation" class="fr-breadcrumb" aria-label="vous √™tes ici :">
  <button class="fr-breadcrumb__button" aria-expanded="false" aria-controls="breadcrumb-1">Voir le fil d'Ariane</button>
  <div class="fr-collapse" id="breadcrumb-1">
    <ol class="fr-breadcrumb__list">
      <li>
        <a class="fr-breadcrumb__link" href="{% url 'app.ads-manager.index' %}">Gestion des ADS</a>
      </li>
      <li>
        <a class="fr-breadcrumb__link" aria-current="page">{{ ads_manager.content_object.display_text|capfirst }}</a>
      </li>
    </ol>
  </div>
</nav>

<h1>ADS de {{ ads_manager.content_object.display_fulltext }}</h1>

<p class="fr-text--lead">
  G√©rez ici les autorisations de stationnement (ADS) de votre administration.
</p>

{% if not ads_manager.is_locked and not ads_manager.no_ads_declared %}
<p>
  üìúÔ∏è&nbsp;<a class="fr-link fr-icon-arrow-right-line fr-link--icon-right" href="{% url 'app.ads-manager.decree.detail' manager_id=ads_manager.id %}">Enregistrer l'arr√™t√© d√©limitant le nombre d'ADS</a>
</p>
<p>
  ‚úçÔ∏è&nbsp;<a class="fr-link fr-icon-arrow-right-line fr-link--icon-right" href="{% url 'app.ads.create' manager_id=ads_manager.id %}">Enregistrer une ADS</a>
</p>
<p>
  üìóÔ∏è&nbsp;<a class="fr-link fr-icon-arrow-down-line fr-link--icon-right" href="{% url 'app.exports.ads-manager' manager_id=ads_manager.id %}">T√©l√©charger toutes les ADS au format excel</a>
</p>
{% endif %}

{% comment %}
  Display the list of ADS if the list is not empty, or if the user has searched for something.
{% endcomment %}
{% if ads_list.count or search_defined %}
<div x-data="{ displayFilters: new URLSearchParams(window.location.search).get('q') || new URLSearchParams(window.location.search).get('accepted_cpam')}">
  <p id="ADSFiltersButton">
    <button
      x-show="! displayFilters"
      x-on:click="displayFilters = true"
      class="fr-link fr-icon-arrow-right-line fr-link--icon-right">
        üîé&nbsp;Rechercher une ADS
    </button>
    <button
      x-show="displayFilters"
      x-on:click="displayFilters = false"
      class="fr-link fr-icon-arrow-down-line fr-link--icon-right">
        üîé&nbsp;Rechercher une ADS
    </button>
  </p>

  <div x-show="displayFilters" id="ADSFilters" x-transition>
    <h6>Filtrer les ADS</h6>

    <form method="get" class="fr-mb-3w">
      <!-- form.q -->
      <div class="fr-col-lg-6 fr-input-group{% if search_form.q.errors %} fr-input-group--error{% endif %}">
        <label class="fr-label" for="{{ search_form.q.id_for_label }}">
          Rechercher par nom ou SIRET du titulaire, ou de l'exploitant, num√©ro de l'ADS, plaque d'immatriculation du v√©hicule{% if ads_manager.content_type.name == 'EPCI' %}, commune‚Ä¶{% endif %}
        </label>

        <input class="fr-input{% if search_form.q.errors %} fr-input--error{% endif %}" type="text"
          id="{{ search_form.q.id_for_label }}" name="{{ search_form.q.html_name }}"
          value="{{ search_form.q.value|default:"" }}" />

        {% for error in search_form.q.errors %}
        <p class="fr-error-text">
          {{ error }}
        </p>
        {% endfor %}
      </div>

      <!-- form.accepted_cpam  -->
      <div
        class="fr-col-lg-6 fr-select-group{% if search_form.accepted_cpam.errors %} fr-select-group--error{% endif %}">
        <label class="fr-label" for="{{ search_form.accepted_cpam.id_for_label }}">
          Lister seulement les ADS conventionn√©es CPAM ?
        </label>

        <select class="fr-select{% if search_form.accepted_cpam.errors %} fr-select--error{% endif %}"
          id="{{ search_form.accepted_cpam.id_for_label }}" name="{{ search_form.accepted_cpam.html_name }}">
          {% for option in search_form.accepted_cpam %}
          {{ option }}
          {% endfor %}
        </select>

        {% for error in search_form.accepted_cpam.errors %}
        <p class="fr-error-text">
          {{ error }}
        </p>
        {% endfor %}
      </div>

      <div class="fr-input-group">
        <button type="submit" class="fr-btn">Filtrer</button>
      </div>
    </form>
  </div>
</div>

<div class="fr-table fr-table--lg fr-table--no-scroll" id="table-stats-pref">
  <div class="fr-table__wrapper">
    <div class="fr-table__container">
      <div class="fr-table__content">
        <table id="table-stats-pref">
          <thead>
            <tr>
              {% if ads_manager.content_type.name == 'EPCI' %}
              <th>üåÜ Commune</th>
              {% endif %}
              <th>‚ôØ Num√©ro</th>
              <th>üìú Date de cr√©ation</th>
              <th>üóì Date d'attribution<br />au titulaire actuel</th>
              <th>üöë Conventionn√©<br />CPAM ?</th>
              <th>ü§¥ Titulaire</th>
              <th>üîé Action</th>
          </thead>
          <tbody>
            {% for ads in ads_list %}
            <tr>
              {% if ads_manager.content_type.name == 'EPCI' %}
              <td>{{ ads.epci_commune.libelle|default:"" }}</td>
              {% endif %}
              <td><a href="{% url 'app.ads.detail' manager_id=ads_manager.id ads_id=ads.id %}">{{ ads.number }}</a></td>
              <td>{{ ads.ads_creation_date|default:"" }}</td>
              <td>{{ ads.attribution_date|default:"" }}</td>
              <td>{% if ads.accepted_cpam is None %}‚ÅâÔ∏è  Inconnu{% elif ads.accepted_cpam is True %}üëç Oui{% else %}‚ùå Non{% endif %}</td>
              <td>{{ ads.owner_name }}</td>
              <td>
                <a class="fr-btn fr-btn--sm" href="{% url 'app.ads.detail' manager_id=ads_manager.id ads_id=ads.id %}">D√©tails</a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="{% if ads_manager.content_type.name == 'EPCI' %}7{% else %}6{% endif %}">Aucun r√©sultat</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% show_pagination_links page_obj %}
      </div>
    </div>
  </div>
</div>

{% comment %}No ADS registered for this ADSManager{% endcomment %}
{% else %}
  {% if ads_manager.is_locked %}
  <div class="fr-alert fr-alert--info fr-mt-2w">
    <h3 class="fr-alert__title">Aucune ADS enregistr√©e</h3>
    <p>Les ADS de votre administration sont import√©es automatiquement par notre √©quipe, mais aucune n'est actuellement enregistr√©e.</p>
  </div>
  {% else %}
    {% if ads_manager.no_ads_declared %}
      <div class="fr-alert fr-alert--info fr-mt-2w">
        <h3 class="fr-alert__title">Aucune ADS enregistr√©e</h3>
        <p>Vous avez d√©clar√© que votre administration ne g√®re aucune ADS. Si il s'agit d'une erreur, ou si votre administration est dor√©navant gestionnaire d'ADS, d√©cochez la case du menu ci-dessous.</p>
      </div>
    {% elif ads_manager.epci_delegate %}
      <div class="fr-alert fr-alert--info fr-mt-2w">
        <h3 class="fr-alert__title">Aucune ADS enregistr√©e</h3>
        <p>La gestion des ADS de votre administration est d√©l√©gu√©e √† l'EPCI <strong>{{ ads_manager.epci_delegate }}</strong></p>
      </div>
    {% else %}
      <div class="fr-alert fr-alert--warning fr-mt-2w">
        <h3 class="fr-alert__title">Aucune ADS enregistr√©e</h3>
        <p>
          Aucune ADS n'est actuellement enregistr√©e pour votre administration. Vous pouvez :
        </p>

        <ul>
          <li>Enregistrer une nouvelle ADS en utilisant le lien ci-dessus</li>
          <li><strong>ou</strong> d√©clarer que votre administration ne g√®re aucune ADS avec le formulaire ci-dessous</li>
          <li><strong>ou</strong> utiliser le formulaire ci-dessous si la gestion des ADS de votre administration est d√©l√©gu√©e √† une EPCI</li>
        </ul>
      </div>
    {% endif %}


    {% if form.non_field_errors %}
      <div class="fr-input-group fr-input-group--error">
        {% for error in form.non_field_errors %}
        <p class="fr-error-text">
          {{ error }}
        </p>
        {% endfor %}
      </div>
    {% endif %}

    <div class="fr-accordions-group fr-mt-2w">
      <section class="fr-accordion">
          <h3 class="fr-accordion__title">
              <button class="fr-accordion__btn" aria-expanded="false" aria-controls="accordion-115">Votre administration ne g√®re aucune ADS</button>
          </h3>
          <div class="{% if not ads_manager.no_ads_declared %}fr-collapse {% endif %}" id="accordion-115">
            <form method="post">
              {% csrf_token %}
              {% include 'form_fields/bool.html' with field=edit_form.no_ads_declared field_errors=edit_form.errors.no_ads_declared required=edit_form.fields.no_ads_declared.required %}

              <div class="fr-col-3 fr-input-group fr-mt-2w">
                <ul class="fr-btns-group">
                  <li>
                    <button type="submit" class="fr-btn">Valider</button>
                  </li>
                </ul>
              </div>
            </form>
          </div>
      </section>
      {% if not edit_form.fields.epci_delegate.disabled %}
      <section class="fr-accordion">
          <h3 class="fr-accordion__title">
              <button class="fr-accordion__btn" aria-expanded="false" aria-controls="accordion-116">La gestion des ADS de votre administration est d√©l√©gu√©e √† un EPCI</button>
          </h3>
          <div class="{% if not ads_manager.epci_delegate %}fr-collapse {% endif %}" id="accordion-116">
            <form method="post">
              {% csrf_token %}

              <div class="fr-select-group{% if edit_form.errors.epci_delegate %} fr-select-group--error{% endif %}">
                <label
                  class="fr-label"
                  for="{{ edit_form.epci_delegate.id_for_label }}"
                >
                  {{ edit_form.epci_delegate.label }}
                  {% if edit_form.epci_delegate.help_text %}<span class="fr-hint-text">{{ edit_form.epci_delegate.help_text }}</span>{% endif %}
                </label>

                {{ edit_form.epci_delegate }}

                {% for error in edit_form.epci_delegate.errors %}
                <p class="fr-error-text">
                  {{ error }}
                </p>
                {% endfor %}
              </div>

              <div class="fr-col-3 fr-input-group fr-mt-2w">
                <ul class="fr-btns-group">
                  <li>
                    <button type="submit" class="fr-btn">Valider</button>
                  </li>
                </ul>
              </div>
            </form>
          </div>
      </section>
      {% endif %}
    </div>
  {% endif %}
{% endif %}

<script src="ads_manager.ts"></script>
{% endblock %}

{% block endbody %}
  {{ block.super }}

  {{ edit_form.media }}
{% endblock %}