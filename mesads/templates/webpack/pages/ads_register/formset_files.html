{% comment %}Render a formset to upload one or several files.{% endcomment %}
<div id="formset-files" class="fr-input-group" x-data="{extra: 0}">
  {{ formset.management_form }}

  {% for form in formset %}
    <div
      class="fr-download fr-download--card formset-file"
      x-data="{deleteFile: false}"
      x-bind:style="deleteFile ? {'background-color': 'rgb(253,222,222)'} : {'background-color': '#fff'}"
      x-transition
    >
      {% if form.instance.file %}
        {{ form.id.as_hidden }}
        {{ form.file.as_hidden }}
        <p class="break-all">
          <a
            class="fr-download__link"
            {% if form.instance.exists_in_storage %}
            href="{{ form.instance.file.url }}"
            target="_blank"
            {% endif %}
          >
            {{ form.instance.human_filename }}
            <span class="fr-download__detail">
              {% if form.instance.exists_in_storage %}
                {{ form.instance.file.size|filesizeformat }}
              {% else %}
                Le fichier n'est plus accessible
              {% endif %}
            </span>
          </a>
        </p>

        <p class="fr-download__desc">
          Le document a été envoyé le {{ form.instance.creation_date|date:"d/m/Y" }}.
        </p>
        <p class="fr-download__desc">
          <input
            id="{{ form.file.id_for_label }}-clear_id"
            name="{{ form.DELETE.html_name }}"
            type="checkbox"
            x-model="deleteFile"
            class="fr-sr-only"
            {% if disabled %}disabled{% endif %}
          />

          <!-- Bouton accessible au clavier -->
          <button
            type="button"
            class="fr-btn fr-btn--secondary fr-btn--sm fr-btn--icon-left"
            :class="deleteFile ? 'fr-icon-download-line' : 'fr-icon-delete-line'"
            @click="deleteFile = !deleteFile"
            :aria-pressed="deleteFile.toString()"
            :aria-controls="'{{ form.file.id_for_label }}-clear_id'"
            {% if disabled %}disabled{% endif %}
          >
            <span x-text="deleteFile ? 'Annuler la suppression' : 'Supprimer le document'"></span>
          </button>
        </p>
      {% endif %}
      {% comment %}Form errors {% endcomment %}
      {% for error in form.errors.file %}
        <p class="fr-error-text">{{ error }}</p>
      {% endfor %}
    </div>
  {% endfor %}

  {% comment %}Extra forms to select new document{% endcomment %}
  <template x-for="i in extra">
    <div
      class="fr-download fr-download--card formset-file"
      x-data="{deleteFile: false}"
      x-bind:style="deleteFile ? {'background-color': 'rgb(253,222,222)'} : {'background-color': '#fff'}"
      x-transition
    >
      <div class="fr-upload-group">
        <label class="fr-label" for="file-upload">
          <strong>Nouveau document</strong>
          <span class="fr-hint-text">Taille maximale : 10 Mo. Format préféré : pdf.</span>
        </label>
        <input
          class="fr-upload"
          type="file"
          id="{{ formset.empty_form.file.id_for_label }}"
          name="{{ formset.empty_form.file.html_name }}"
        />
      </div>
    </div>
  </template>

  {% for error in formset.non_form_errors %}
    <p class="fr-error-text">{{ error }}</p>
  {% endfor %}
  
  <button
    type="button"
    class="fr-btn fr-btn--sm fr-icon-add-circle-line fr-btn--icon-left fr-btn--secondary"
    @click="extra++"
    x-add-file-button
    :disabled="
      typeof update !== 'undefined'
        ? (!update || {{ disabled|yesno:'true,false' }})
        : {{ disabled|yesno:'true,false' }}
    "
  >
    Ajouter un document
  </button>
</div>
